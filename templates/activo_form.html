{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }}{% endblock %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ page_title }}</h6>
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    {{ form|crispy }}

                    <hr>
                    <h5 class="text-primary">Switches Fortinet</h5>

                    <div id="formset-switches">
                        {{ formset.management_form }}
                        {% for form in formset %}
                        <div class="switch-form mb-3 border p-3 rounded bg-light position-relative" data-index="{{ forloop.counter0 }}">
                            <div class="row">
                                <div class="col-md-4">
                                    {{ form.modelo_equipo.label_tag }}
                                    {{ form.modelo_equipo }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.serie.label_tag }}
                                    {{ form.serie }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.oblea.label_tag }}
                                    {{ form.oblea }}
                                </div>
                            </div>

                            {% if not form.instance.pk and not forloop.first %}
                                <button type="button" class="btn btn-outline-danger btn-sm mt-2 remove-switch">
                                    <i class="bi bi-x-circle"></i> Eliminar este Switch
                                </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" class="btn btn-success btn-sm mb-3" id="add-switch">
                        <i class="bi bi-plus-circle"></i> Agregar otro Switch
                    </button>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <a href="{% url 'listar_activos' %}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const addButton = document.getElementById('add-switch');
  const formContainer = document.getElementById('formset-switches');

  // Detectar prefix dinámicamente a partir del management form
  const totalInput = formContainer.querySelector('input[name$="-TOTAL_FORMS"]');
  if (!addButton || !formContainer || !totalInput) return;

  const prefix = totalInput.name.split('-')[0]; // ej: "switch"
  const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);

  addButton.addEventListener('click', function () {
    const formCount = parseInt(totalForms.value, 10);
    const firstForm = formContainer.querySelector('.switch-form');
    if (!firstForm) return;

    const newForm = firstForm.cloneNode(true);

    // Limpiar valores
    newForm.querySelectorAll('input, select').forEach(el => {
      if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
      else el.value = '';
    });

    // Actualizar índices (name/for/id) según prefix
    const re = new RegExp(`${prefix}-(\\d+)-`, 'g');
    newForm.innerHTML = newForm.innerHTML.replace(re, `${prefix}-${formCount}-`);

    // Botón eliminar (si no existe)
    if (!newForm.querySelector('.remove-switch')) {
      const deleteButton = document.createElement('button');
      deleteButton.className = 'btn btn-outline-danger btn-sm mt-2 remove-switch';
      deleteButton.type = 'button';
      deleteButton.innerHTML = '<i class="bi bi-x-circle"></i> Eliminar este Switch';
      newForm.appendChild(deleteButton);
    }

    newForm.setAttribute('data-index', formCount);
    formContainer.appendChild(newForm);
    totalForms.value = formCount + 1;
  });

  // Eliminar y reindexar
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.remove-switch');
    if (!btn) return;

    const forms = formContainer.querySelectorAll('.switch-form');
    if (forms.length <= 1) return;

    btn.closest('.switch-form').remove();

    // Reindexar todos
    const currentForms = formContainer.querySelectorAll('.switch-form');
    currentForms.forEach((formEl, idx) => {
      const re = new RegExp(`${prefix}-(\\d+)-`, 'g');
      formEl.innerHTML = formEl.innerHTML.replace(re, `${prefix}-${idx}-`);
      formEl.setAttribute('data-index', idx);
    });
    totalForms.value = currentForms.length;
  });
});
</script>


{% endblock %}
